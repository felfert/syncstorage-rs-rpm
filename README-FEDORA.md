# How to setup your own firefox sync server

After installing the package `syncstorage-rs`, it is mandatory to perform several additional tasks

### 1. Create a mariadb user and database

- If you do not have a working mariadb installation, see [here]( https://docs.fedoraproject.org/en-US/quick-docs/installing-mysql-mariadb/#_install_from_fedora_main_repo).
- Run the following command(s) in a shell:
```
DBPASSWORD=$(openssl rand -base64 128)
echo The database password is ${DBPASSWORD}
sudo mysql -u root <<EOF
CREATE USER "ffsync"@"localhost" IDENTIFIED BY "${DBPASSWORD}";
CREATE DATABASE ffsync;
GRANT ALL PRIVILEGES on ffsync.* to ffsync@localhost;
EOF
```
### 2. Customize /etc/syncserver.toml

- Edit `/etc/syncserver.toml`

  Change the values of `master_secret`, `syncstorage.database_url` and `tokenserver.database_url`.
  `master_secret` should be a random string that could be generated by running `openssl rand -base64 128`
  Both database urls should point to the same database created above. the generic syntax for those urls is
  mysql://`username`:`password`@`hostname`/`dbname`[?`options`]
  The example values use a unix socket. If your database happens to run on a remote machine, then you must remove the trailing `?socket=%2Fvar%2Flib%2Fmysql%2Fmysql.sock`.

### 3. Customize /etc/sysconfig/syncserver

- Edit `/etc/sysconfig/syncserver`

  In this file, the environment variables used by the syncserver are specified.

  - `RUST_LOG` specifies the log devel
  - `PUBLIC_URL` specifies the URL which is used from the client side. This points to the public side of a reverse proxy. See sample apache config below. The string value is used to set the node value in the nodes table.
 - `MAX_CLIENTS` specifies the maximum number of users, that can use this syncserver. For a personal syncserver, you usually want to keep the dfault of `1`.

### 4. Setup reverse proxy (apache virtual host)

 Here is an example config that goes into /etc/httpd/conf.d/ffsync.conf:
```
<VirtualHost *:443>
    ServerAdmin me@mydomain.tld
    ServerName sync.mydomain.tld
    DocumentRoot /var/www/html/empty
    ErrorLog logs/ffsync.mydomain.tld-error_log
    CustomLog logs/ffsync.mydomain.tld-access_log combined
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/ffsync.mydomain.tld/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/ffsync.mydomain.tld/privkey.pem

    ProxyPreserveHost on
    <Location />
        ProxyPass http://127.0.0.1:8000/
        RequestHeader set X-Forwarded-Proto "https"
    </Location>

</VirtualHost>
```
The SSL setup using letsencrypt is beyond the scope of this document.
Just note, that the generic parts of the SSL configuration are in `/etc/httpd/conf.d/ssl.conf` which is automatically effective for all virtualhosts on the local machine.
Regarding letsencrypt: On the current target distibutions of this package (Fedora and RHEL), there is
a package named certbot available. I suggest you, consult the docs of that package. You can search for that package [here](https://pkgs.org/search/?q=certbot).

### 5 Setup FireFox to use your new syncserver

#### FireFox for Desktop

- Sign out of your FireFox account
- Enter `about:config` into the URL bar
- Set the preference `identity.sync.tokenserver.uri` to the value `https://ffsync.mydomain.tld/1.0/sync/1.5`
- Sign in to your FireFox account. It should immediately sync (perhaps a little longer than usual, because it has to push all data)

#### FireFox for Mobile

- Go to `Settings` → `About Firefox`
- Tap on the FireFox Browser logo 5 times
- Go back and scroll up to Sync Debug, click it
- Set Custom Sync Server to https://ffsync.mydomain.tld/1.0/sync/1.5
- Stop and restart the FireFox app
- On a desktop computer running FireFox (signed in), go to https://firefox.com/pair and follow the steps until you're shown a QR code
- On the mobile, go to `Settings` → `Synchronize` → `Ready to scan` and scan the QR code on the desktop computer
- Alternatively, if you don't have a desktop computer, go to `Settings` → `Synchronize` → `Use email` instead
