name: CI

on:
  push:
    branches:
      'master'
    tags:
      '[0-9]+\.[0-9]+\.[0-9]+'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  DEBIAN_FRONTEND: noninteractive
  PPA_SIGNING_PASS: ${{ secrets.PPA_SIGNING_PASS }}

jobs:
  build:
    if: ${{ github.event_name != 'pull_request' }} # If this is a pull request, stop here
    name: Build ubuntu package
    outputs:
      artifact-id: ${{ steps.artifact-upload-step.outputs.artifact-id }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Setup build environment
        run: |
          sudo apt-get install -y devscripts equivs
          mk-build-deps --build-dep debian/control
          sudo apt-get install -y ./*.deb
          rm -f *_*
      - name: Setup GPG
        run: |
          echo "${{ secrets.PPA_SIGNING_KEY }}" | gpg --batch --import --yes
      - name: Build package
        run: |
          TARGET=noble
          UPSTREAM_VERSION=$(dpkg-parsechangelog -l debian/changelog.in -S Version | sed -e 's/-.*//')
          SRCNAME=$(dpkg-parsechangelog -l debian/changelog.in -S Source)
          ORIG="${SRCNAME}_${UPSTREAM_VERSION}.orig"
          SRCDIR="${SRCNAME}-${UPSTREAM_VERSION}"
          curl -L https://github.com/mozilla-services/syncstorage-rs/archive/refs/tags/${UPSTREAM_VERSION}.tar.gz -o ${ORIG}.tar.gz
          rm -rf ${SRCDIR}
          tar xzf ${ORIG}.tar.gz
          cp -a debian ${SRCDIR}/
          cp -a *.patch ${SRCDIR}/debian/patches
          cp syncserver.env syncserver.toml ${SRCDIR}/debian/
          cp README-FEDORA.md ${SRCDIR}/debian/README.md
          sed -e 's/sysconfig/default/' < syncserver.service > ${SRCDIR}/debian/syncserver.service
          sed -e "s/+TARGET+/${TARGET}/" < debian/changelog.in > ${SRCDIR}/debian/changelog
          rm -f ${SRCDIR}/debian/changelog.in
          echo -e "#!/bin/bash\ngpg --batch --pinentry-mode loopback --passphrase \"${{ secrets.PPA_SIGNING_PASS }}\" \"\$@\"" > ppasign
          chmod a+x ppasign
          PPASIGN="$(pwd)/ppasign"
          KID="$(gpg -k | grep "^ " | tr -d " ")"
          (cd ${SRCDIR} && dpkg-buildpackage -S -k"${KID}" -p"${PPASIGN}")
          (cd ${SRCDIR} && dpkg-buildpackage -b -k"${KID}" -p"${PPASIGN}")
          rm -rf ${SRCDIR}
      - name: Save artifacts
        uses: actions/upload-artifact@v4
        with:
          name: syncstorage-rs
          retention-days: 1
          if-no-files-found: error
          path: |
            *_*

  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || ( github.event_name == 'push' && github.ref_type == 'tag' ) }}
    needs: [build]
    name: Call CD
    uses: ./.github/workflows/cd.yml
    secrets: inherit
    with:
      artifact-name: syncstorage-rs
